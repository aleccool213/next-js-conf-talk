## Use Next.js static-site generation with Cosmic Headless CMS

<Notes>

* The new Static-site generation features in Next.js
* Using a Headless CMS to manage content, [Cosmic CMS](https://www.cosmicjs.com/)

</Notes>

---

### Alec Brunelle

### Senior Software Developer @ [Unity Technologies](https://unity.com/) ðŸŽ®

<Notes>

Hi there! I'm Alec Brunelle and I'm a senior software developer at Unity Technologies on the Live Services team.

</Notes>

---

<li>
    Using Next.js for over 2+ years
</li>
<li>
    Freelance and side-projects
</li>

---

Agenda

* What is a real-time website? What is a static website? Why a CMS?
* How does Next.js achieve this?
* Why use a headless CMS?
* Walkthrough: Integrating Cosmic CMS into a Next.js app

---

Who this talk is for:

* Developers with React experience just getting into Next.js
* Developers who haven't started using the new Next.js SSG features
* Developers who want to integrate a Headless CMS into a Next.js app

---

### You have a problem

<Steps>

  - You need to make a website
  - The data doesn't change too often
  - The admins don't want to manage the content using a Database or Git repo

</Steps>

---

#### Websites generally fall into two buckets

<Steps>
    <li>Real-time</li>
    <li>Static</li>
</Steps>

---

#### Real-time Websites versus Static Websites

Plenty of use cases for both

---

#### Common misconception

Static sites are less complex

---

#### Common misconception

~~Static sites are less complex~~

---

#### Real-time Websites

<Steps>
    <li>HTML is compiled on each request</li>
    <li>Data for a page is fetched on page load</li>
    <li>Data for a page is fetched on the same server which compiles the HTML/CSS/JS</li>
    <li>Enables service-side rendering (SSR)</li>
    <li>Requires Node.js process to run on the server</li>
    <li>Example: Social network or Messenger</li>
</Steps>

---

#### Static Websites

<Steps>
    <li>HTML for a page is generated at build time and reused with each request</li>
    <li>Data is fetched at build time</li>
    <li>Portable, just a folder of HTML/CSS/JS (old-school)</li>
    <li>Requires no process to run on the server</li>
    <li>Example: A blog, band website or e-commerce store</li>
</Steps>

---

### How does Next.js achieve both of these?

---

Next.js has primarly been a framework for building real-time data applications. 

Recently has added the ability to build static websites.

---

`getInitialProps` runs at render time:


```jsx
function PageSSR({ stars }) {
  return <div>Next stars: {stars}</div>
}

PageSSR.getInitialProps = async (context) => {
  const res = await fetch('https://api.github.com/repos/vercel/next.js')
  const json = await res.json()
  return { stars: json.stargazers_count }
}

export default PageSSR
```

---

#### "The Great Split"

<Steps>

* Next.js now lets you choose which rendering strategy you want for each page in your website
* Next.js split `getInitialProps` into two functions, one for server-side rendering and one for static-site generation

</Steps>

---

Post Next.js 9.3


```jsx
function PageSSRNext93({ stars }) {
  return <div>Next stars: {stars}</div>
}

PageSSRNext93.getServerSideProps = async (context) => {
  const res = await fetch('https://api.github.com/repos/vercel/next.js')
  const json = await res.json()
  return { stars: json.stargazers_count }
}

export default PageSSRNext93
```

---

How do we enable static-site generation?

Next.js gives us the ability to do this per page

---

`getStaticProps` runs at build time:

```jsx
function PageSSG({ stars }) {
  return <div>Next stars: {stars}</div>
}

PageSSG.getStaticProps = async (context) => {
  const res = await fetch('https://api.github.com/repos/vercel/next.js')
  const json = await res.json()
  return { stars: json.stargazers_count }
}

export default PageSSG
```

---

Unique SSG things to think about

* Page Data
* Page Routes
* Builds
* Development and Previewing

---

## Page Data

* Get the data needed to render the page
* Example, a blog post or a concert date

---

Places it can be stored

<Steps>
    <li>The same Git Repo as the website</li>
    <li>External API you don't own</li>
    <li>CMS you manage (Cosmic, etc)</li>
</Steps>

---

## Example getting blog post data from an API

```javascript
// pages/posts/[slug].js
export async function getStaticProps({ params }) {
  const data = await api.getPost(params.slug);
  const content = await markdownToHtml(data.post?.metadata?.content || "");

  return {
    props: {
      post: {
        ...data.post,
        content,
      },
    },
  };
}
```

---

## Page Routes

* Get all potential page routes
* In a real-time web app, these are usually determined as run-time
* Example: https://my-blog.com/posts/my-first-blog-post

---

## Example creating routes based on blog post slugs

```javascript
// pages/posts/[slug].js
export async function getStaticPaths() {
  const allPosts = (await getAllPostsWithSlug()) || [];
  return {
    paths: allPosts.map((post) => `/posts/${post.slug}`),
    fallback: true,
  };
}
```


---

## Builds

* When you build, the data is fetched
* Can be done in various places

---

## Example

* Locally, then send files to server for hosting
* Externally on a service like Vercel which handles building and deployments
* When an event happens, E.g. Webhooks

---

## Development and Previewing

* When you develop the website locally
* Next.js will grab the content as you navigate
  * Need to call `build` for it to get all content

---

## Example

* Using [Next.js preview mode](https://nextjs.org/docs/advanced-features/preview-mode) in Cosmic CMS to show draft content

---

Why use a Headless CMS?

* Website content and data can be managed by non-technical users
* They shouldn't be using Git and pushing code
* Example: You are a freelancer and build a website, want to hand-off website to the client. They can use the CMS to manage the content.

---

Walkthrough: Using Cosmic with Next.js SSG

---

[Cosmic](https://www.cosmicjs.com/) is an intuitive, powerful, and simple-to-use service which lets us get up and running quickly. 

---

One of the best parts is that they provide [many starter apps](https://www.cosmicjs.com/apps) that you can preview or fork.

---

*Switches over to screen share*

---

Creating the Cosmic Project

<Notes>

- Create the cosmic project from the next.js starter app: https://www.cosmicjs.com/apps/nextjs-static-blog
- explain that it creates a cosmic bucket (sort of like where a single websites data lives)
- creates some data types which are usually in a blog (Posts, Authors)
- creates some example data in those data types
- now that we have the content, time to build the blog!

</Notes>

---

Local Development

<Notes>

- clone the repo: https://github.com/vercel/next.js/tree/canary/examples/cms-cosmic
- show pages and components, with tailwind for css
- mention how basic it is, show around the app for a bit
- time to show running: yarn dev
- show it working (you already entered in keys to make it work)

</Notes>

---

Next.js SSG Bits

<Notes>

- show where `getStaticProps` and `getStaticPaths` lives
  - explain how they work

</Notes>

---

Deployment with Vercel

<Notes>

- show pushing the code to a new repo with github cli
- import the project on the vercel dashboard, enter the same env keys
- show website working

</Notes>

---


Webhooks

<Notes>

- explain why webhooks are needed
- explain how right now new content only is published when master is pushed to and vercel builds the website
- can set up a deploy hook on Vercel
- show getting the webhook url in cosmic and entering in on Vercel

</Notes>

---

Preview Mode

<Notes>

- explain preview mode
- explain how everything you publish in cosmic would be seen in production when you deployed
- explain how it allows you to save drafts of your content on cosmic and view it locally
  - great to see how things look locally
- show how to setup preview mode

</Notes>

---

## The End
